<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wire Bending Machine 3D - HowToMechatronics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }

        #canvas3d {
            width: 100%;
            height: 100%;
        }

        .overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 26, 0.95);
            padding: 15px 30px;
            border-radius: 8px;
            border: 2px solid #3a7bc8;
            text-align: center;
            z-index: 100;
        }

        .overlay h2 {
            font-size: 18px;
            color: #3a7bc8;
            font-weight: 600;
        }

        .overlay p {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.95);
            padding: 30px 50px;
            border-radius: 10px;
            border: 2px solid #3a7bc8;
            text-align: center;
            z-index: 200;
        }

        .loading h3 {
            color: #3a7bc8;
            margin-bottom: 15px;
        }

        .loading-bar {
            width: 200px;
            height: 6px;
            background: #2a2a2a;
            border-radius: 3px;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #3a7bc8, #00ff88);
            width: 0%;
            transition: width 0.3s;
        }

        .loading-text {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 26, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            z-index: 100;
        }

        .controls h4 {
            color: #3a7bc8;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .controls p {
            font-size: 11px;
            color: #888;
            margin: 3px 0;
        }

        .part-list {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(26, 26, 26, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            z-index: 100;
            max-height: 60vh;
            overflow-y: auto;
            min-width: 200px;
        }

        .part-list h4 {
            color: #3a7bc8;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .part-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
            font-size: 11px;
            border-bottom: 1px solid #2a2a2a;
        }

        .part-item:last-child {
            border-bottom: none;
        }

        .part-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .part-name {
            color: #ccc;
        }

        .btn-group {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .btn {
            background: #3a7bc8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #4a8bd8;
        }

        .btn-secondary {
            background: #555;
        }

        .btn-secondary:hover {
            background: #666;
        }

        .info-box {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(26, 26, 26, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ff9500;
            z-index: 100;
            max-width: 280px;
        }

        .info-box h4 {
            color: #ff9500;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .info-box p {
            font-size: 11px;
            color: #aaa;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="overlay">
        <h2>Arduino 3D Wire Bending Machine</h2>
        <p>Modelo: HowToMechatronics | Arraste para rotacionar</p>
    </div>

    <div class="loading" id="loadingScreen">
        <h3>Carregando Modelo 3D</h3>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingText">Iniciando...</div>
    </div>

    <div class="info-box">
        <h4>Nota sobre a Montagem</h4>
        <p>Os arquivos STL contem apenas as pecas impressas em 3D. A estrutura de MDF/compensado e os motores nao estao incluidos nos arquivos disponiveis.</p>
        <p style="margin-top: 8px;">Para o modelo completo montado, baixe o arquivo STEP do <a href="https://thangs.com/m/44026" target="_blank" style="color: #3a7bc8;">Thangs</a>.</p>
    </div>

    <div class="controls">
        <h4>Controles da Camera</h4>
        <p>Botao esquerdo: Rotacionar</p>
        <p>Scroll: Zoom</p>
        <p>Botao direito: Mover</p>
    </div>

    <div class="part-list" id="partList">
        <h4>Componentes</h4>
    </div>

    <div class="btn-group">
        <button class="btn" onclick="resetCamera()">Resetar Camera</button>
        <button class="btn btn-secondary" onclick="toggleWireframe()">Wireframe</button>
        <button class="btn btn-secondary" onclick="explodeView()">Explodir Vista</button>
    </div>

    <div id="canvas3d"></div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>

    <script>
        // ============================================================================
        // CONFIGURACAO
        // ============================================================================
        let scene, camera, renderer, controls;
        let loadedParts = [];
        let loadingComplete = false;
        let isWireframe = false;
        let isExploded = false;

        // Estrutura da maquina baseada no tutorial HowToMechatronics:
        // - Base: MDF 8mm + compensado 18mm (nao incluido nos STLs)
        // - Eixo Z: tubo oco 15mm com rolamentos 6202
        // - Alimentador: no topo, empurra o arame
        // - Cabecote de dobra: conectado ao eixo Z
        // - Motores: NEMA 17 (eixo Z e alimentador) + NEMA 23 (dobra) + Servo MG996R

        const PARTS = [
            // === ALIMENTADOR (TOPO) ===
            {
                file: 'Feeder.STL',
                name: 'Alimentador',
                color: 0x4a90d9,
                position: { x: 0, y: 120, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: 80, z: 0 }
            },
            {
                file: 'Straightener roller.STL',
                name: 'Rolo Endireitador',
                color: 0x888888,
                position: { x: -60, y: 120, z: 0 },
                rotation: { x: 0, y: 0, z: Math.PI/2 },
                scale: 1,
                explodeOffset: { x: -60, y: 80, z: 0 }
            },

            // === EIXO Z (CENTRAL) ===
            {
                file: 'Z-axis gear 1.STL',
                name: 'Engrenagem Z 1 (30 dentes)',
                color: 0x3d7cbf,
                position: { x: 0, y: 60, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: 40, z: 0 }
            },
            {
                file: 'Z-axis gear 2.STL',
                name: 'Engrenagem Z 2 (18 dentes)',
                color: 0x5588cc,
                position: { x: 40, y: 60, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 60, y: 40, z: 0 }
            },
            {
                file: 'Pillow block.STL',
                name: 'Mancal Superior',
                color: 0x3a6090,
                position: { x: 0, y: 80, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: 60, z: 0 }
            },
            {
                file: 'Pillow block.STL',
                name: 'Mancal Inferior',
                color: 0x3a6090,
                position: { x: 0, y: 40, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: 20, z: 0 }
            },

            // === CABECOTE DE DOBRA ===
            {
                file: 'Bender gear 1.STL',
                name: 'Engrenagem Dobra (30 dentes)',
                color: 0x2d6caf,
                position: { x: 0, y: 0, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: -20, z: 0 }
            },
            {
                file: 'bender gear modified.STL',
                name: 'Engrenagem Motor Dobra',
                color: 0x4478bc,
                position: { x: 50, y: 0, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 80, y: -20, z: 0 }
            },
            {
                file: 'Bender nozzle.STL',
                name: 'Bico Dobrador',
                color: 0xff6600,
                position: { x: 0, y: -10, z: 30 },
                rotation: { x: 0, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: -40, z: 50 }
            },
            {
                file: 'rack pin.STL',
                name: 'Pino Cremalheira',
                color: 0xcc4400,
                position: { x: 0, y: -10, z: 50 },
                rotation: { x: Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: -40, z: 80 }
            },
            {
                file: 'Servo - pinion gear.STL',
                name: 'Pinhao Servo',
                color: 0x666666,
                position: { x: 30, y: -10, z: 40 },
                rotation: { x: 0, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 50, y: -40, z: 60 }
            },

            // === SUPORTES ===
            {
                file: 'Shaft clamp.STL',
                name: 'Bracadeira Eixo 1',
                color: 0x4a7ab0,
                position: { x: 0, y: 20, z: 25 },
                rotation: { x: 0, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: 0, z: 50 }
            },
            {
                file: 'Shaft clamp.STL',
                name: 'Bracadeira Eixo 2',
                color: 0x4a7ab0,
                position: { x: 0, y: 20, z: -25 },
                rotation: { x: 0, y: Math.PI, z: 0 },
                scale: 1,
                explodeOffset: { x: 0, y: 0, z: -50 }
            },
            {
                file: 'Nema 17 mount.STL',
                name: 'Suporte Motor NEMA 17',
                color: 0x333333,
                position: { x: 60, y: 60, z: 0 },
                rotation: { x: -Math.PI/2, y: 0, z: 0 },
                scale: 1,
                explodeOffset: { x: 100, y: 40, z: 0 }
            }
        ];

        // ============================================================================
        // INICIALIZACAO
        // ============================================================================
        function init() {
            const container = document.getElementById('canvas3d');

            // Cena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Camera
            camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                5000
            );
            camera.position.set(200, 150, 250);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // Controles
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 50, 0);

            // Luzes
            setupLights();

            // Ambiente
            createEnvironment();

            // Criar estrutura base (MDF simulado)
            createBaseStructure();

            // Criar tubo central (eixo Z)
            createZAxisTube();

            // Carregar STLs
            loadAllSTLs();

            // Eventos
            window.addEventListener('resize', onWindowResize);

            // Loop
            animate();
        }

        function setupLights() {
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);

            const main = new THREE.DirectionalLight(0xffffff, 0.8);
            main.position.set(200, 300, 200);
            main.castShadow = true;
            scene.add(main);

            const fill = new THREE.DirectionalLight(0x4488ff, 0.3);
            fill.position.set(-100, 100, -100);
            scene.add(fill);

            const back = new THREE.DirectionalLight(0xffffff, 0.2);
            back.position.set(0, 100, -200);
            scene.add(back);
        }

        function createEnvironment() {
            // Grid
            const grid = new THREE.GridHelper(400, 20, 0x444444, 0x333333);
            grid.position.y = -60;
            scene.add(grid);

            // Eixos
            const axes = new THREE.AxesHelper(30);
            axes.position.y = -59;
            scene.add(axes);
        }

        function createBaseStructure() {
            // Base de MDF/compensado (representacao simplificada)
            const baseMat = new THREE.MeshStandardMaterial({
                color: 0x8B4513,  // Marrom madeira
                roughness: 0.8
            });

            // Placa superior
            const topPlate = new THREE.Mesh(
                new THREE.BoxGeometry(150, 8, 120),
                baseMat
            );
            topPlate.position.set(0, 100, 0);
            topPlate.castShadow = true;
            topPlate.receiveShadow = true;
            scene.add(topPlate);

            // Placa inferior
            const bottomPlate = new THREE.Mesh(
                new THREE.BoxGeometry(150, 8, 120),
                baseMat
            );
            bottomPlate.position.set(0, -50, 0);
            bottomPlate.castShadow = true;
            bottomPlate.receiveShadow = true;
            scene.add(bottomPlate);

            // Colunas
            const columnMat = new THREE.MeshStandardMaterial({
                color: 0x9B5523,
                roughness: 0.7
            });

            const positions = [
                { x: -60, z: -45 },
                { x: -60, z: 45 },
                { x: 60, z: -45 },
                { x: 60, z: 45 }
            ];

            positions.forEach(pos => {
                const column = new THREE.Mesh(
                    new THREE.BoxGeometry(18, 150, 18),
                    columnMat
                );
                column.position.set(pos.x, 25, pos.z);
                column.castShadow = true;
                scene.add(column);
            });
        }

        function createZAxisTube() {
            // Tubo oco de 15mm (eixo Z principal)
            const tubeMat = new THREE.MeshStandardMaterial({
                color: 0xB87333,  // Cobre
                metalness: 0.8,
                roughness: 0.3
            });

            // Tubo externo
            const tubeGeo = new THREE.CylinderGeometry(7.5, 7.5, 180, 32);
            const tube = new THREE.Mesh(tubeGeo, tubeMat);
            tube.position.set(0, 25, 0);
            scene.add(tube);

            // Furo interno (mais escuro)
            const holeMat = new THREE.MeshStandardMaterial({
                color: 0x333333
            });
            const holeGeo = new THREE.CylinderGeometry(5, 5, 182, 32);
            const hole = new THREE.Mesh(holeGeo, holeMat);
            hole.position.set(0, 25, 0);
            scene.add(hole);
        }

        // ============================================================================
        // CARREGAMENTO DOS STLs
        // ============================================================================
        function loadAllSTLs() {
            const loader = new THREE.STLLoader();
            let loaded = 0;
            const total = PARTS.length;

            PARTS.forEach((part, index) => {
                const filePath = 'models/' + part.file;
                updateLoading(loaded, total, 'Carregando: ' + part.name);

                loader.load(
                    filePath,
                    (geometry) => {
                        // Centralizar geometria
                        geometry.computeBoundingBox();
                        const center = new THREE.Vector3();
                        geometry.boundingBox.getCenter(center);
                        geometry.translate(-center.x, -center.y, -center.z);

                        const material = new THREE.MeshStandardMaterial({
                            color: part.color,
                            metalness: 0.3,
                            roughness: 0.6
                        });

                        const mesh = new THREE.Mesh(geometry, material);
                        mesh.position.set(part.position.x, part.position.y, part.position.z);
                        mesh.rotation.set(part.rotation.x, part.rotation.y, part.rotation.z);
                        mesh.scale.setScalar(part.scale);
                        mesh.castShadow = true;
                        mesh.receiveShadow = true;

                        // Guardar posicao original para explode view
                        mesh.userData.originalPosition = { ...part.position };
                        mesh.userData.explodeOffset = part.explodeOffset;

                        scene.add(mesh);
                        loadedParts.push({ mesh, part, material });

                        loaded++;
                        updateLoading(loaded, total, 'Carregado: ' + part.name);
                        addPartToList(part);

                        if (loaded === total) {
                            finishLoading();
                        }
                    },
                    undefined,
                    (error) => {
                        console.error('Erro ao carregar ' + part.file + ':', error);
                        loaded++;
                        if (loaded === total) {
                            finishLoading();
                        }
                    }
                );
            });
        }

        function updateLoading(loaded, total, text) {
            const percent = (loaded / total) * 100;
            document.getElementById('loadingProgress').style.width = percent + '%';
            document.getElementById('loadingText').textContent = text;
        }

        function finishLoading() {
            loadingComplete = true;
            document.getElementById('loadingScreen').style.display = 'none';
            console.log('Modelo carregado!');
        }

        function addPartToList(part) {
            const list = document.getElementById('partList');
            const item = document.createElement('div');
            item.className = 'part-item';
            item.innerHTML = `
                <div class="part-color" style="background: #${part.color.toString(16).padStart(6, '0')}"></div>
                <span class="part-name">${part.name}</span>
            `;
            list.appendChild(item);
        }

        // ============================================================================
        // FUNCOES DE VISUALIZACAO
        // ============================================================================
        function resetCamera() {
            camera.position.set(200, 150, 250);
            controls.target.set(0, 50, 0);
        }

        function toggleWireframe() {
            isWireframe = !isWireframe;
            loadedParts.forEach(({ material }) => {
                material.wireframe = isWireframe;
            });
        }

        function explodeView() {
            isExploded = !isExploded;

            loadedParts.forEach(({ mesh }) => {
                const orig = mesh.userData.originalPosition;
                const offset = mesh.userData.explodeOffset;

                if (isExploded) {
                    mesh.position.set(
                        orig.x + offset.x,
                        orig.y + offset.y,
                        orig.z + offset.z
                    );
                } else {
                    mesh.position.set(orig.x, orig.y, orig.z);
                }
            });
        }

        // ============================================================================
        // LOOP E EVENTOS
        // ============================================================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Iniciar
        init();
    </script>
</body>
</html>
