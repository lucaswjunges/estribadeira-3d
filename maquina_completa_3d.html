<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wire Bending Machine 3D - Modelo Completo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }

        #canvas3d {
            width: 100%;
            height: 100%;
        }

        .overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 26, 0.95);
            padding: 15px 30px;
            border-radius: 8px;
            border: 2px solid #00ff88;
            text-align: center;
            z-index: 100;
        }

        .overlay h2 {
            font-size: 18px;
            color: #00ff88;
            font-weight: 600;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.95);
            padding: 40px 60px;
            border-radius: 10px;
            border: 2px solid #00ff88;
            text-align: center;
            z-index: 200;
        }

        .loading h3 {
            color: #00ff88;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .loading-bar {
            width: 250px;
            height: 8px;
            background: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #3a7bc8);
            width: 0%;
            transition: width 0.3s;
        }

        .loading-text {
            margin-top: 15px;
            font-size: 13px;
            color: #888;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 26, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            z-index: 100;
        }

        .controls h4 {
            color: #00ff88;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .controls p {
            font-size: 11px;
            color: #888;
            margin: 4px 0;
        }

        .btn-group {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }

        .btn {
            background: #00ff88;
            color: #1a1a1a;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #00cc6a;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #3a3a3a;
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: #4a4a4a;
        }

        .legend-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(26, 26, 26, 0.95);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            z-index: 100;
            max-width: 280px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .legend-panel h4 {
            color: #00ff88;
            margin-bottom: 12px;
            font-size: 14px;
            border-bottom: 1px solid #3a3a3a;
            padding-bottom: 8px;
        }

        .legend-stats {
            font-size: 11px;
            color: #888;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2a2a2a;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 4px 5px;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 4px;
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .legend-item.highlighted {
            background: rgba(0, 255, 136, 0.2);
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 8px;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .legend-name {
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .legend-panel::-webkit-scrollbar {
            width: 6px;
        }

        .legend-panel::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 3px;
        }

        .legend-panel::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="overlay">
        <h2>Automatic 3D Wire Bending Machine</h2>
    </div>

    <div class="loading" id="loadingScreen">
        <h3>Carregando Modelo 3D</h3>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-text" id="loadingText">Iniciando...</div>
    </div>

    <div class="controls">
        <h4>Controles da Camera</h4>
        <p>Arrastar: Rotacionar</p>
        <p>Scroll: Zoom</p>
        <p>Shift + Arrastar: Mover</p>
        <p>Duplo clique: Centralizar</p>
    </div>

    <div class="legend-panel" id="legendPanel">
        <h4>Pecas do Modelo</h4>
        <div class="legend-stats" id="legendStats">Carregando...</div>
        <div id="legendItems"></div>
    </div>

    <div class="btn-group">
        <button class="btn" onclick="resetCamera()">Resetar Camera</button>
        <button class="btn btn-secondary" onclick="toggleWireframe()">Wireframe</button>
        <button class="btn btn-secondary" onclick="toggleAutoRotate()">Auto Rotacao</button>
        <button class="btn btn-secondary" onclick="cycleBackground()">Mudar Fundo</button>
    </div>

    <div id="canvas3d"></div>

    <!-- Three.js + STLLoader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>

    <script>
        // ============================================================================
        // VARIAVEIS GLOBAIS
        // ============================================================================
        let scene, camera, renderer, controls;
        let modelGroup = null;
        let partMeshes = [];
        let partsManifest = null;
        let isWireframe = false;
        let backgroundIndex = 0;
        const backgrounds = [0x1a1a1a, 0x2a3a4a, 0x3a2a3a, 0x1a2a1a, 0x000000];

        // Paleta de cores distintas (20 cores que se repetem)
        const colorPalette = [
            0x4CAF50, 0x2196F3, 0xF44336, 0xFF9800, 0x9C27B0,
            0x00BCD4, 0xFFC107, 0xE91E63, 0x8BC34A, 0x3F51B5,
            0xFF5722, 0x009688, 0xCDDC39, 0x673AB7, 0x03A9F4,
            0x795548, 0x607D8B, 0xFFEB3B, 0x00E676, 0xD500F9
        ];

        let loadedCount = 0;
        let totalParts = 0;

        // ============================================================================
        // INICIALIZACAO
        // ============================================================================
        function init() {
            const container = document.getElementById('canvas3d');

            // Cena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(backgrounds[0]);

            // Camera
            camera = new THREE.PerspectiveCamera(
                45,
                window.innerWidth / window.innerHeight,
                0.1,
                10000
            );
            camera.position.set(300, 200, 400);

            // Renderer
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            container.appendChild(renderer.domElement);

            // Controles
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;
            controls.minDistance = 50;
            controls.maxDistance = 2000;
            controls.target.set(0, 50, 0);

            // Luzes
            setupLights();

            // Grid
            const grid = new THREE.GridHelper(500, 25, 0x444444, 0x333333);
            grid.position.y = -10;
            scene.add(grid);

            // Grupo para o modelo
            modelGroup = new THREE.Group();
            scene.add(modelGroup);

            // Carregar manifest e depois as pecas
            loadManifest();

            // Eventos
            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('dblclick', onDoubleClick);

            // Loop
            animate();
        }

        function setupLights() {
            // Ambiente
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);

            // Hemisphere (ceu/chao)
            const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
            hemi.position.set(0, 200, 0);
            scene.add(hemi);

            // Principal
            const main = new THREE.DirectionalLight(0xffffff, 0.8);
            main.position.set(150, 300, 200);
            main.castShadow = true;
            main.shadow.mapSize.width = 2048;
            main.shadow.mapSize.height = 2048;
            main.shadow.camera.near = 10;
            main.shadow.camera.far = 1000;
            main.shadow.camera.left = -200;
            main.shadow.camera.right = 200;
            main.shadow.camera.top = 200;
            main.shadow.camera.bottom = -200;
            scene.add(main);

            // Preenchimento
            const fill = new THREE.DirectionalLight(0x88aaff, 0.3);
            fill.position.set(-100, 100, -100);
            scene.add(fill);

            // Rim
            const rim = new THREE.DirectionalLight(0xffffff, 0.2);
            rim.position.set(0, 50, -200);
            scene.add(rim);
        }

        // ============================================================================
        // CARREGAMENTO DO MANIFEST
        // ============================================================================
        function loadManifest() {
            updateLoading(5, 'Carregando manifest...');

            fetch('models/parts_manifest.json')
                .then(response => response.json())
                .then(data => {
                    partsManifest = data;
                    totalParts = data.parts.length;
                    console.log(`Manifest carregado: ${totalParts} pecas`);
                    createLegend();
                    loadAllParts();
                })
                .catch(error => {
                    console.error('Erro ao carregar manifest:', error);
                    document.getElementById('loadingText').textContent = 'Erro ao carregar manifest!';
                });
        }

        // ============================================================================
        // CRIACAO DA LEGENDA
        // ============================================================================
        function createLegend() {
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';

            partsManifest.parts.forEach((part, index) => {
                const color = colorPalette[index % colorPalette.length];

                const item = document.createElement('div');
                item.className = 'legend-item';
                item.dataset.index = index;

                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = '#' + color.toString(16).padStart(6, '0');

                const nameSpan = document.createElement('span');
                nameSpan.className = 'legend-name';
                // Simplificar o nome removendo prefixo comum
                let displayName = part.name.replace('Automatic_3D_Wire_Bending_Machine', 'Peca');
                if (displayName === 'Peca') displayName = 'Peca_000';
                nameSpan.textContent = displayName;
                nameSpan.title = `${part.name} (${part.faces} faces)`;

                item.appendChild(colorBox);
                item.appendChild(nameSpan);

                // Interatividade
                item.addEventListener('mouseenter', () => highlightPart(index, true));
                item.addEventListener('mouseleave', () => highlightPart(index, false));
                item.addEventListener('click', () => focusOnPart(index));

                legendItems.appendChild(item);
            });
        }

        function highlightPart(index, highlight) {
            const mesh = partMeshes[index];
            if (mesh) {
                if (highlight) {
                    mesh.userData.originalEmissive = mesh.material.emissive.getHex();
                    mesh.material.emissive.setHex(0x444444);
                } else {
                    mesh.material.emissive.setHex(mesh.userData.originalEmissive || 0x000000);
                }
            }

            const legendItem = document.querySelector(`.legend-item[data-index="${index}"]`);
            if (legendItem) {
                legendItem.classList.toggle('highlighted', highlight);
            }
        }

        function focusOnPart(index) {
            const mesh = partMeshes[index];
            if (mesh) {
                const box = new THREE.Box3().setFromObject(mesh);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);

                controls.target.copy(center);
                const distance = Math.max(maxDim * 3, 50);
                const direction = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
                camera.position.copy(center).add(direction.multiplyScalar(distance));
            }
        }

        // ============================================================================
        // CARREGAMENTO DAS PECAS
        // ============================================================================
        function loadAllParts() {
            const loader = new THREE.STLLoader();

            updateLoading(10, 'Carregando pecas...');

            partsManifest.parts.forEach((part, index) => {
                const filePath = 'models/parts/' + part.file;
                const color = colorPalette[index % colorPalette.length];

                loader.load(
                    filePath,
                    (geometry) => {
                        // Material com cor especifica
                        const material = new THREE.MeshStandardMaterial({
                            color: color,
                            metalness: 0.4,
                            roughness: 0.5,
                            flatShading: false
                        });

                        // Criar mesh
                        const mesh = new THREE.Mesh(geometry, material);
                        mesh.castShadow = true;
                        mesh.receiveShadow = true;
                        mesh.userData.partName = part.name;
                        mesh.userData.partIndex = index;

                        // Posicionar na posicao original do STEP
                        // (a geometria ja vem na posicao correta)

                        partMeshes[index] = mesh;
                        modelGroup.add(mesh);

                        loadedCount++;
                        const percent = 10 + (loadedCount / totalParts) * 85;
                        updateLoading(percent, `Carregando: ${loadedCount}/${totalParts}`);

                        if (loadedCount === totalParts) {
                            onAllPartsLoaded();
                        }
                    },
                    undefined,
                    (error) => {
                        console.error(`Erro ao carregar ${part.file}:`, error);
                        loadedCount++;
                        if (loadedCount === totalParts) {
                            onAllPartsLoaded();
                        }
                    }
                );
            });
        }

        function onAllPartsLoaded() {
            console.log('Todas as pecas carregadas!');

            // Centralizar o grupo
            const box = new THREE.Box3().setFromObject(modelGroup);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            // Mover grupo para o centro
            modelGroup.position.sub(center);
            modelGroup.position.y += size.y / 2;

            // Ajustar camera
            const maxDim = Math.max(size.x, size.y, size.z);
            camera.position.set(maxDim * 1.2, maxDim * 0.8, maxDim * 1.2);
            controls.target.set(0, size.y / 3, 0);
            controls.minDistance = maxDim * 0.3;
            controls.maxDistance = maxDim * 4;

            // Atualizar estatisticas
            let totalVertices = 0;
            let totalFaces = 0;
            partMeshes.forEach(mesh => {
                if (mesh && mesh.geometry) {
                    totalVertices += mesh.geometry.attributes.position.count;
                    totalFaces += mesh.geometry.attributes.position.count / 3;
                }
            });

            document.getElementById('legendStats').innerHTML =
                `<strong>${partMeshes.filter(m => m).length}</strong> pecas carregadas<br>` +
                `<strong>${totalVertices.toLocaleString()}</strong> vertices<br>` +
                `<strong>${Math.round(totalFaces).toLocaleString()}</strong> triangulos`;

            finishLoading();
        }

        function updateLoading(percent, text) {
            document.getElementById('loadingProgress').style.width = percent + '%';
            document.getElementById('loadingText').textContent = text;
        }

        function finishLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
            console.log('Modelo carregado com sucesso!');
        }

        // ============================================================================
        // FUNCOES DE CONTROLE
        // ============================================================================
        function resetCamera() {
            if (modelGroup) {
                const box = new THREE.Box3().setFromObject(modelGroup);
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);

                camera.position.set(maxDim * 1.2, maxDim * 0.8, maxDim * 1.2);
                controls.target.set(0, size.y / 3, 0);
            }
        }

        function toggleWireframe() {
            isWireframe = !isWireframe;
            partMeshes.forEach(mesh => {
                if (mesh && mesh.material) {
                    mesh.material.wireframe = isWireframe;
                }
            });
        }

        function toggleAutoRotate() {
            controls.autoRotate = !controls.autoRotate;
            controls.autoRotateSpeed = 2.0;
        }

        function cycleBackground() {
            backgroundIndex = (backgroundIndex + 1) % backgrounds.length;
            scene.background = new THREE.Color(backgrounds[backgroundIndex]);
        }

        function onDoubleClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            const mouse = new THREE.Vector2(
                ((event.clientX - rect.left) / rect.width) * 2 - 1,
                -((event.clientY - rect.top) / rect.height) * 2 + 1
            );

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(partMeshes.filter(m => m), true);
            if (intersects.length > 0) {
                controls.target.copy(intersects[0].point);
                const clickedMesh = intersects[0].object;
                if (clickedMesh.userData.partName) {
                    console.log('Peca clicada:', clickedMesh.userData.partName);
                }
            }
        }

        // ============================================================================
        // LOOP E EVENTOS
        // ============================================================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Iniciar
        init();
    </script>
</body>
</html>
